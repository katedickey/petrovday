<html>
  <head>
    <title>Petrov Day</title>
    <script type="text/javascript" src="/static/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="/static/smoothie.js"></script>
    <script type="text/javascript" src="/static/mustache.min.js"></script>
    <script type="text/javascript" src="/static/hypothesis.js"></script>

    <style>
      #content {
        display: flex;
        flex-direction: row;
        align-items: center;
        flex-wrap: wrap;
      }

      .enemy-container {
        border: 1px solid black;
        margin: 0.5em;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        flex-grow: 40%;
      }

      .button-container {
        display: flex;
        flex-direction: row;
      }

      .ews-canvas {
        padding: 1em;
      }

      .lrr-readouts {
        border-collapse: collapse;
      }
      .lrr-readouts td,th {
        border: 1px solid black;
        padding: 0 1em;
        text-align: center;
      }
    </style>
    <script>

      var MISSILE_FLIGHT_TIME_SECONDS = 3*60;
      var LRR_READOUT_INTERVALS = [[180, 165], [165, 150], [150, 120],
                                   [120, 60], [60, 30], [30, 0]];

      var enemies = {};


      // Standard Normal variate using Box-Muller transform.
      // Stolen from https://stackoverflow.com/a/36481059
      function normalvariate() {
          var u = 1 - Math.random(); // Subtraction to flip [0, 1) to (0, 1].
          var v = 1 - Math.random();
          return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
      }

      function forEachKV(obj, f) {
        Object.entries(obj).forEach(function(kv){f(kv[0], kv[1]);});
      }

      var integerTime = 0;
      function note_ews_readings(readings) {

        nData = Object.getOwnPropertyNames(readings).length;
        integerTime += nData;

        var readingTime = new Date();
        readingTime.setSeconds(readingTime.getSeconds() - nData);
        forEachKV(readings, function(t, readingsByEnemyName) {
          readingTime.setSeconds(readingTime.getSeconds() + 1);
          t = parseInt(t);
          forEachKV(readingsByEnemyName, function(enemyName, reading) {
            var e = enemies[enemyName];
            e.hypothesisSet.updateRelativeRepresentativenesses(t, reading);
            e.timeSeries.append(readingTime.getTime(), 100 * ((reading ? 1 : -1) + normalvariate()/10));
          });
        });

        forEachKV(enemies, function(enemyName, e) {
          LRR_READOUT_INTERVALS.forEach(function(interval) {
            var lrr = Math.round(e.hypothesisSet.getMaxLogRelativeRepresentativenessInRange(integerTime-interval[0], integerTime-interval[1]));
            e.container.find(`.lrr-readouts td[data-for-interval="${interval}"]`).text(Number.isFinite(lrr) ? lrr.toString() : "--");
            e.container.find(`.lrr-readouts tr[data-for-interval="${interval}"]`).css({'background-color': (lrr > 2 ? 'pink' : 'initial')});
          });
        });

      }

      function read_ewss_forever() {
        $.get('./read_ewss', {'since': integerTime},
          function(data) {
            note_ews_readings(JSON.parse(data));
            setTimeout(function(){read_ewss_forever()}, 500);
          });
      }

      ENEMY_CONTAINER_TEMPLATE = `
        <div class="enemy-container" id="{{enemyName}}">
          <p><strong>{{enemyName}}</strong></p>
          <div class="button-container">
            <button class="launch-button">Launch</button>
            <button class="drill-button">Drill</button>
          </div>
          <canvas class="ews-canvas" width="500" height="300" />
          <table class="lrr-readouts">
            <tr>
              <th> Representativeness </th>
              <th> of launch in last ____ seconds </th>
            </tr>
            ${LRR_READOUT_INTERVALS.sort(function(a,b){return a-b}).map(
              function(interval) {
                return `
                  <tr data-for-interval="${interval}">
                    <td data-for-interval="${interval}"> 0 </td>
                    <td> ${interval.join("-")} </td>
                  </tr>`
              }
            ).join('')}
          </table>
        </div>
      `

      function add_enemy(enemyName) {
        var e = {'hypothesisSet': new HypothesisSet()};

        e.container = $(Mustache.render(ENEMY_CONTAINER_TEMPLATE, {'enemyName': enemyName}));
        $('#content').append(e.container);

        e.container.find('.launch-button').on('click', function(){$.get('launch/'+enemyName)});
        e.container.find('.drill-button').on('click', function(){$.get('drill/'+enemyName)});

        e.chart = new SmoothieChart({
          grid: {
            millisPerLine: 10000,
            verticalSections: 0
          },
          horizontalLines: [
            {color:'#ffffff',lineWidth:1,value:0},
            {color:'#880000',lineWidth:2,value:100},
            {color:'#880000',lineWidth:2,value:-100}
          ],
          millisPerPixel: 333,
          maxValue: 150,
          minValue: -180,
          timestampFormatter: SmoothieChart.timeFormatter,
          labels: {disabled: true}
        });
        e.chart.streamTo(e.container.find('.ews-canvas')[0], 0/*delay*/);

        e.timeSeries = new TimeSeries();

        e.chart.addTimeSeries(e.timeSeries, {lineWidth:2,strokeStyle:'#ffff00'});

        enemies[enemyName] = e;
      }

      $(function() {

        $.get('enemies', function(data) {
          JSON.parse(data).forEach(function(enemyName) {
            add_enemy(enemyName);
          })
          read_ewss_forever();
        });

      });
    </script>
  </head>
  <body>
    <div id="content" />
  </body>
</html>
